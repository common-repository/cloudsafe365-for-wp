<?php
 /*
  * Description of cloudsafe365
  *
  * @author cloudsafe365
  */

 class cs365_malware_scan
  {
  function cs365_malware_scan() {
   $this->get_defs();
   ##file_definitions php
   $this->get_defs_files(5);
   ##file_definitions js
   $this->get_defs_files(4);
  }

  //put your code here
  function cs365_scan_now($file, $file_id, $deep, $next_scan_id) {
   $basename = basename($file);
   $this->file_id = $file_id;
   $this->next_scan_id = $next_scan_id;

   if ($deep == 0) {
    $line = file_get_contents($file);
    $this->cs365_check($line, -1, $file, $basename);
    $this->deep_scan = 1;
   }
   else {
    //Running deep scan on file malware found.
    $this->deep_scan_lineno = 1;
//                        foreach (file($file) as $line_num => $line)
//                        $this->cs365_check($line, $line_num, $file, $basename);
   }


   if (isset($this->definitions_phpfiles))
     for ($i = 0; $i < count($this->definitions_phpfiles); $i++)
      $this->cs365_def_4_5(stripslashes($this->definitions_phpfiles[$i]), $basename, $this->def_id_phpfiles[$i]);

   if (isset($this->definitions_jsfiles))
     for ($i = 0; $i < count($this->definitions_jsfiles); $i++)
      $this->cs365_def_4_5(stripslashes($this->definitions_jsfiles[$i]), $basename, $this->def_id_jsfiles[$i]);
   if (preg_match('/\.html$|\.htm$/xsi', $basename))
     $this->cd3865_hard_codedhtml($file);
  }

  function cs365_check($code, $line_num, $file, $basename) {
   for ($i = 0; $i < count($this->definitions); $i++) {
    switch ($this->def_id[$i])
     {
     case (1) :
      $this->cs365_def1($i, $code, $line_num, $file);
      break;
     case (2) :
      $this->cs365_def2($i, $code, $line_num, $file);
      break;
     default :
     }
   }
  }

  function cs365_def1($i, $code, $line_num, $file) {
   $strPattern = '/\s' . preg_replace('/\s/xsi', '\s', $this->definitions[$i]) . '\s/xsi';
   preg_match($strPattern, $code, $matches);
   if (isset($matches[0])) {
    $this->malware_match($file, $line_num, $this->def_id[$i], $matches[0], $this->definitions_id[$i]);
   }
  }

  function cs365_def2($i, $code, $line_num, $file) {
   $strPattern = '/' . $this->definitions[$i] . '/xsi';
   preg_match($strPattern, preg_replace('/\s+/xsi', '', $code), $matches);
   if (isset($matches[0])) {
    $this->malware_match($file, $line_num, $this->def_id[$i], $matches[0], $this->definitions_id[$i]);
   }
  }

  function cs365_def_4_5($definition, $file, $def_id_phpfiles) {
   if ($definition == $file) {
    $this->malware_match($file, 'file', $def_id_phpfiles, $file, $definition);
   }
  }

  function cd3865_hard_codedhtml($file) {
   $this->malware_match($file, 'file', '0', $file, 'HTML file found');
  }

  function malware_match($file, $line_num, $def_id, $matches, $id) {
   if (preg_match('/\d/xsi', $line_num))
     $line_num +=1;
   $this->detected_object = 1;

##Only put into databse if we are running a deep scan
   if (isset($this->deep_scan)) {
    $request = "INSERT
INTO
	cs365_malware_results
SET
	file_id = '" . $this->file_id . "',
	def_id = '$def_id',
	id_type = '$id',
	time_found = '" . time() . "',
	last_scan_id = '$this->next_scan_id'";
    mysql_query($request) or print mysql_error();
   }
  }

  function get_defs() {
   $request = "SELECT id,defs,def_id FROM cs365_malware_defs WHERE def_id !=5";
   $mysql = mysql_query($request) or print mysql_error();
   $num_mysql = mysql_num_rows($mysql) or print mysql_error();
   if ($num_mysql > 0) {
    while ($row = mysql_fetch_assoc($mysql)) {
     $this->definitions[] = base64_decode($row['defs']);
     $this->def_id[] = $row['def_id'];
     $this->definitions_id[] = $row['id'];
    }
   }
  }

  function get_defs_files($no) {
   $request = "SELECT id,defs,def_id FROM cs365_malware_defs WHERE def_id =" . $no;
   $mysql = mysql_query($request) or print mysql_error();
   $num_mysql = mysql_num_rows($mysql) or print mysql_error();


   if ($num_mysql > 0) {
    while ($row = mysql_fetch_assoc($mysql)) {
     if ($no == 5) {
      $this->definitions_phpfiles[] = base64_decode($row['defs']);
      $this->def_id_phpfiles[] = $row['def_id'];
      $this->definitions_id_phpfiles[] = $row['id'];
     }
     else {
      $this->definitions_jsfiles[] = base64_decode($row['defs']);
      $this->def_id_jsfiles[] = $row['def_id'];
      $this->definitions_id_jsfiles[] = $row['id'];
     }
    }
   }
  }

  }

 /* ________________________________________________________________
   ________________________________________________________________ */
 function cs365malware_scan_id() {
  $request = "
SELECT
	last_scan_id
FROM
	cs365_malware_results
Order by  id desc
LIMIT
	1
";
  $mysql = mysql_query($request) or print mysql_error();
  $num_mysql = mysql_num_rows($mysql) or print mysql_error();

  if ($num_mysql > 0) {
   list($last_scan_id) = mysql_fetch_row($mysql);
   $last_scan_id+=1;
   return $last_scan_id;
  }
  else
    return 1;
 }

 /* ________________________________________________________________ */
?>