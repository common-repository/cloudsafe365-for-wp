<?php
          add_action('wp_ajax_cs365_scan_now', 'cs365_malware_scanner');
          function cs365_malware_scanner() {
               require_once(WP_PLUGIN_DIR . '/cloudsafe365-for-wp/lib/cs365_malware_system.php');
               ##Scanner...
               $cs365_malware_system = new cs365_malware_system('db');

               $cs365_malware_system->start = $_POST["goto_start"] - 10;
               $cs365_malware_system->finish = $_POST["goto_start"];
               $cs365_malware_system->next = $cs365_malware_system->finish + 10;
               $cs365_malware_system->counter = 0;
               $cs365_malware_system->files = array();
               $cs365folders = array();
               $root =preg_replace('/\W+wp-content/xsi', '', WP_CONTENT_DIR);
               $cs365folders['content'] = $root;
               if (count($cs365folders) == 0) exit;

               foreach ($cs365folders as $cs365wp_type => $cs365wpfolder) {
                    $cs365_malware_system->cs365listFiles($cs365wpfolder, $cs365wp_type);
                    if (count($cs365_malware_system->files) > 0) {
                         $callback['next'] = $cs365_malware_system->next;
                         $callback['cs365wp_type'] = preg_replace('/themes/xsi', 'theme', $cs365wp_type);
                         for ($i = 0; $i < count($cs365_malware_system->files); $i++) {
                              $file = pathinfo($cs365_malware_system->files[$i]);
			 if (preg_match('/\.jpg|\.png|\.gif|\.webp|\.jpeg/xsi', $cs365_malware_system->files[$i]))
				 {
				$img = '<img src="'.str_replace($root,str_replace('/wp-content','',WP_CONTENT_URL),$cs365_malware_system->files[$i]).'" width="25" height="25" />';
				}
				else
					$img = '&nbsp;';
                              $callback['filename'][] = $file['filename'];
                              $callback['extension'][] = $file['extension'];
                              $callback['image'][] = $img;
                              $callback['size'][] =$cs365_malware_system->info[$i]['size'].'kb';
			$callback['modified'][] =date('d-M-Y', $cs365_malware_system->info[$i]['filemtime']);
                              $callback['directory'][] = str_replace($root,'', $file['dirname']);
                              $callback['prepdone'][] = $cs365_malware_system->prepdone[$i];
                         }
                         echo json_encode($callback);
                         exit;
                    }
               }
               exit;
          }

?>